---
image: wptest
services:
  - mysql:latest

variables:
  # Configure mysql service (https://hub.docker.com/_/mysql/)
  WORDPRESS_DB_NAME: wp_test_db
  WORDPRESS_DB_USER: root
  MYSQL_ROOT_PASSWORD: mysql_strong_password
  MYSQL_HOST: localhost
  REAL_MYSQL_HOST: mysql

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - bash -c 'ssh-add <(echo "$SSH_PRIVATE_KEY")'
  - '[[ -f /.dockerenv ]] && mkdir -p ~/.ssh && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  - 'composer install --quiet'

stages:
  - build
  - test
  - qa
  - deploy
  - documentation

#PhpUnit:
#  stage: test
#  when: always
#  image: otgs/phpunit
#  tags:
#    - docker
#  script:
#    - ./vendor/otgs/build-tools-ci/otgs-ci -p
#  except:
#    - tags

PhpUnit-Legacy:
  stage: test
  when: always
  tags:
    - docker
  script:
    - ./vendor/otgs/build-tools-ci/otgs-ci -p --legacy
  except:
    - tags

Tag-Artifact:
  stage: build
  when: on_success
  image: artbuilder
  tags:
    - artifacts
  script:
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    name: "${CI_PROJECT_NAME}-${CI_BUILD_REF_NAME}"
    paths:
      - ${CI_PROJECT_NAME}
  only:
    - tags

Branch-Artifact:
  stage: deploy
  when: on_success
  image: artbuilder
  tags:
    - artifacts
  script:
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    expire_in: 1h
    name: "${CI_PROJECT_NAME}-${CI_BUILD_REF_NAME}-${CI_BUILD_ID}"
    paths:
      - ${CI_PROJECT_NAME}
  except:
    - tags
    - /^pre-release.*$/

Prereleases-Artifact:
  stage: qa
  when: on_success
  image: artbuilder
  tags:
    - artifacts
  script:
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    expire_in: 4 weeks
    name: "${CI_PROJECT_NAME}-${CI_BUILD_REF_NAME}-${CI_BUILD_ID}"
    paths:
      - ${CI_PROJECT_NAME}
  only:
    - /^pre-release.*$/

Release-Notes:
  stage: documentation
  when: on_success
  image: artbuilder
  tags:
    - artifacts
  script:
    - ./vendor/otgs/build-tools-ci/otgs-ci --releasenotes
  only:
    - tags
