---
variables:
    # Configure mysql service (https://hub.docker.com/_/mysql/)
    WORDPRESS_DB_NAME: wp_test_db
    WORDPRESS_DB_USER: root
    MYSQL_ROOT_PASSWORD: mysql_strong_password
    MYSQL_HOST: localhost
    REAL_MYSQL_HOST: mysql

before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - bash -c 'ssh-add <(echo "$SSH_PRIVATE_KEY")'
    - '[[ -f /.dockerenv ]] && mkdir -p ~/.ssh && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

stages:
    - pre-flight
    - quality
    - test
    - build
    - documentation
    - deploy

Prepare <Cache>:
    stage: pre-flight
    cache: &cache-commit
        untracked: true
        key: "$CI_COMMIT_REF_NAME"
        paths:
            - node_modules/
            - vendor/
            - changelog/
            - readme.txt
        policy: push
    when: always
    image: registry.otgs.work/infrastructure/docker-images/phpunit:7.3
    script:
        - composer install
        - npm install
        - ./vendor/bin/otgs-changelog update --project ${OTGS_CI_YOUTRACK_PROJECT_ID} --target-version all --path ./changelog --filename-template {version}.md

Compatibility <PHP>:
    stage: quality
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/phpunit:7.3
    tags:
        - autoscale
    script:
        - vendor/bin/phpcs --standard=./phpcs.compatibility.xml -s -p --colors --report-full --report-summary ./
    only:
        - branches

Duplication <PHP>:
    stage: quality
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/phpunit:7.3
    tags:
        - autoscale
    script:
        - vendor/bin/phpcpd --exclude=tests --exclude=vendor -- ./
    only:
        - branches

Unit <PHP>:
    stage: test
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/otgs/phpunit:5.7
    tags:
        - autoscale
    script:
        - ./vendor/bin/phpunit --configuration=./tests/phpunit/phpunit.xml --fail-on-warning
    only:
        - branches

Integration <PHP>:
    stage: test
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/wptest:7.3
    services:
        - mysql:5.7
    tags:
        - autoscale
    script:
        - ./vendor/bin/otgs-php-integration-tests
    only:
        - branches

Branch:
    stage: build
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - composer install --no-dev
        - ./.make/deploy-copy.js -t ./${CI_PROJECT_NAME}
        - ./.make/deploy-cleanup.js -t ./${CI_PROJECT_NAME}
    artifacts:
        expire_in: 48h
        name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}.${CI_BUILD_ID}"
        paths:
            - ${CI_PROJECT_NAME}
    except:
        - master
        - develop
        - tags

Develop:
    stage: build
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - composer install --no-dev
        - ./.make/deploy-copy.js -t ./${CI_PROJECT_NAME}
        - ./.make/deploy-cleanup.js -t ./${CI_PROJECT_NAME}
    artifacts:
        expire_in: 7 days
        name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}.${CI_BUILD_ID}"
        paths:
            - ${CI_PROJECT_NAME}
    only:
        - develop

Master:
    stage: build
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - composer install --no-dev
        - ./.make/deploy-copy.js -t ./${CI_PROJECT_NAME}
        - ./.make/deploy-cleanup.js -t ./${CI_PROJECT_NAME}
    artifacts:
        expire_in: 6 mos
        name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}.${CI_BUILD_ID}"
        paths:
            - ${CI_PROJECT_NAME}
    only:
        - master

Tag:
    stage: build
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - composer install --no-dev
        - ./.make/deploy-copy.js -t ./${CI_PROJECT_NAME}
        - ./.make/deploy-update-version.js -t ./${CI_PROJECT_NAME} -r ${CI_COMMIT_TAG}
        - ./.make/deploy-cleanup.js -t ./${CI_PROJECT_NAME}
    artifacts:
        name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}"
        paths:
            - ${CI_PROJECT_NAME}
    only:
        - tags

Release Notes:
    stage: documentation
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - ./vendor/otgs/build-tools-ci/otgs-ci --releasenotes
    only:
        - tags

S3:
    stage: deploy
    cache:
        <<: *cache-commit
        policy: pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - ./vendor/bin/publish-artifact-to-s3
    dependencies:
        - Tag
        - Develop
        - Master
        - Branch
    only:
        - tags
        - develop
        - master
