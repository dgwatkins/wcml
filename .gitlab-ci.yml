---
image: wptest:php7
services:
  - mysql:latest

variables:
  # Configure mysql service (https://hub.ec2.com/_/mysql/)
  WORDPRESS_DB_NAME: wp_test_db
  WORDPRESS_DB_USER: root
  MYSQL_ROOT_PASSWORD: mysql_strong_password
  MYSQL_HOST: localhost
  REAL_MYSQL_HOST: mysql

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - bash -c 'ssh-add <(echo "$SSH_PRIVATE_KEY")'
  - '[[ -f /.dockerenv ]] && mkdir -p ~/.ssh && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  - 'php --version'
  - 'composer install --quiet'

stages:
  - quality
  - test
  - build
  - documentation
  - deploy

Compatibility <PHP>:
  stage: quality
  when: always
  image: otgs/phpunit:5.7
  tags:
    - ec2
  script:
    - vendor/bin/phpcs --standard=./phpcs.compatibility.xml -s -p --colors --report-full --report-summary ./
  except:
    - tags

Unit <PHP>:
  stage: test
  when: always
  image: otgs/phpunit:5.7
  tags:
    - ec2
  script:
    - cd tests/phpunit
    - ../../vendor/bin/phpunit --fail-on-warning
  except:
    - tags

Integration <PHP>:
  stage: test
  when: always
  tags:
    - ec2
  script:
    - ./vendor/otgs/build-tools-ci/otgs-ci -p --legacy
  except:
    - tags

Tag:
  stage: build
  when: always
  image: artbuilder:php7
  tags:
    - ec2
  script:
    - ./vendor/bin/otgs-changelog update --project wcml --target-version all --path ./changelog
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}"
    paths:
      - ${CI_PROJECT_NAME}
  only:
    - tags

Branch:
  stage: build
  when: on_success
  image: artbuilder:php7
  tags:
    - ec2
  script:
    - ./vendor/bin/otgs-changelog update --project wcml --target-version all --path ./changelog
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    expire_in: 1h
    name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}.${CI_BUILD_ID}"
    paths:
      - ${CI_PROJECT_NAME}
  except:
    - master
    - develop
    - tags
    - /^pre-release.*$/
    - /^functional.*$/

Pre-Release:
  stage: build
  when: on_success
  image: artbuilder:php7
  tags:
    - ec2
  script:
    - ./vendor/bin/otgs-changelog update --project wcml --target-version all --path ./changelog
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    expire_in: 4 weeks
    name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}.${CI_BUILD_ID}"
    paths:
      - ${CI_PROJECT_NAME}
  only:
    - /^pre-release.*$/

Develop:
  stage: build
  when: on_success
  image: artbuilder:php7
  tags:
    - ec2
  script:
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    expire_in: 7 days
    name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}.${CI_BUILD_ID}"
    paths:
      - ${CI_PROJECT_NAME}
  only:
    - develop

Master:
  stage: build
  when: on_success
  image: artbuilder:php7
  tags:
    - ec2
  script:
    - ./vendor/bin/otgs-changelog update --project wcml --target-version all --path ./changelog
    - ./vendor/otgs/build-tools-ci/otgs-ci -d --deploytype=src --deploytarget=./
  artifacts:
    expire_in: 6 mos
    name: "${CI_PROJECT_NAME}.${CI_BUILD_REF_NAME}.${CI_BUILD_ID}"
    paths:
      - ${CI_PROJECT_NAME}
  only:
    - master

Release Notes:
  stage: documentation
  when: on_success
  image: artbuilder:php7
  tags:
    - ec2
  script:
    - ./vendor/bin/otgs-changelog update --project wcml --target-version all --path ./changelog
    - ./vendor/otgs/build-tools-ci/otgs-ci --releasenotes
  only:
    - tags
  except:

S3:
  stage: deploy
  when: on_success
  image: artbuilder:php7
  tags:
    - ec2
  script:
    - ./vendor/bin/publish-artifact-to-s3
  dependencies:
  - Tag
  - Develop
  - Master
  only:
    - tags
    - develop
    - master
